# Import necessary modules and functions
import requests
from weather_project.settings import WEATHER_API_KEY
from django.http import HttpResponseBadRequest
# Function to get weather data for a given city
def get_weather(city):
    # Construct the base URL for the weather API using the API key and city
    base_url = f"http://api.weatherapi.com/v1/forecast.json?key={WEATHER_API_KEY}&q={city}&days=3&aqi=no&alerts=no"

    try:
        # Make a POST request to the weather API
        response = requests.post(base_url)
         # Check for bad request (HTTP status code 400)
        if response.status_code == 400:
            return HttpResponseBadRequest("Bad request to weather API: Invalid data")
        # Parse the JSON response
        weather_data = response.json()
        # Extract relevant data from the response
        return  extract_data_from_response(weather_data) 
    except requests.exceptions.HTTPError as errh:
        return errh
    except requests.exceptions.ConnectionError as errc:
        return errc
    except requests.exceptions.Timeout as errt:
        return errt
    except requests.exceptions.RequestException as err:
        return err

# Function to extract relevant data from the API response
def extract_data_from_response(response):
    try:
        # Create a dictionary to store the extracted data
        needed_response = {}
        # Extract location data
        location_data = response['location']
        needed_response['location'] = location_data
        # Extract current weather data
        current = response["current"]
        current_data = {
            "temp_c": current["temp_c"], "text": current["condition"]["text"], "icon": "https:"+current["condition"]["icon"]}
        needed_response['current'] = current_data
        # Extract forecast data
        forecast = response["forecast"]["forecastday"]
        forecast_data = {}
        for day in forecast:
            forecast_data[day["date"]] = {
                "mintemp_c": day["day"]["mintemp_c"], "maxtemp_c": day["day"]["maxtemp_c"]}
            hours = {}
            for j in day["hour"]:
                hours[j["time"]] = {
                    "temp_c": j["temp_c"], "text": j["condition"]["text"], "icon": "https:"+j["condition"]["icon"]}
            forecast_data[day["date"]]["hours"] = hours
        needed_response["forecast"] = forecast_data
        return needed_response
    except Exception as e:
        return e

# Sample context data for testing
context_data = {'location': {'name': 'Indore', 'region': 'Madhya Pradesh', 'country': 'India', 'lat': 22.72, 'lon': 75.83, 'tz_id': 'Asia/Kolkata', 'localtime_epoch': 1706103304, 'localtime': '2024-01-24 19:05'}, 'current': {'temp_c': 18.0, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, 'forecast': {'2024-01-24': {'mintemp_c': 11.0, 'maxtemp_c': 23.2, 'hours': {'2024-01-24 00:00': {'temp_c': 13.1, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 01:00': {'temp_c': 12.9, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 02:00': {'temp_c': 12.5, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 03:00': {'temp_c': 12.3, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 04:00': {'temp_c': 12.1, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 05:00': {'temp_c': 12.0, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 06:00': {'temp_c': 11.8, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 07:00': {'temp_c': 12.0, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 08:00': {'temp_c': 15.0, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 09:00': {'temp_c': 18.1, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 10:00': {'temp_c': 20.4, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 11:00': {'temp_c': 22.0, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 12:00': {'temp_c': 23.2, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 13:00': {'temp_c': 23.6, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 14:00': {'temp_c': 23.8, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 15:00': {'temp_c': 23.8, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 16:00': {'temp_c': 23.5, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 17:00': {'temp_c': 21.5, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-24 18:00': {'temp_c': 18.4, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 19:00': {'temp_c': 18.0, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 20:00': {'temp_c': 16.8, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 21:00': {'temp_c': 16.0, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 22:00': {'temp_c': 15.3, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-24 23:00': {'temp_c': 14.9, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}}}, '2024-01-25': {'mintemp_c': 11.8, 'maxtemp_c': 25.0, 'hours': {'2024-01-25 00:00': {'temp_c': 14.7, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 01:00': {'temp_c': 14.5, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 02:00': {'temp_c': 14.1, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 03:00': {'temp_c': 13.8, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 04:00': {'temp_c': 13.6, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 05:00': {'temp_c': 13.3, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 06:00': {'temp_c': 13.1, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 07:00': {'temp_c': 13.1, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 08:00': {'temp_c': 16.0, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 09:00': {'temp_c': 19.2, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 10:00': {'temp_c': 21.4,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 11:00': {'temp_c': 22.7, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 12:00': {'temp_c': 24.0, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 13:00': {'temp_c': 24.9, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 14:00': {'temp_c': 25.5, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 15:00': {'temp_c': 25.6, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 16:00': {'temp_c': 25.2, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 17:00': {'temp_c': 23.0, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-25 18:00': {'temp_c': 19.5, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 19:00': {'temp_c': 18.2, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 20:00': {'temp_c': 17.6, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 21:00': {'temp_c': 17.1, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 22:00': {'temp_c': 16.7, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-25 23:00': {'temp_c': 16.3, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}}}, '2024-01-26': {'mintemp_c': 12.9, 'maxtemp_c': 26.4, 'hours': {'2024-01-26 00:00': {'temp_c': 16.0, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 01:00': {'temp_c': 15.6, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 02:00': {'temp_c': 15.2, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 03:00': {'temp_c': 14.8, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 04:00': {'temp_c': 14.2, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 05:00': {'temp_c': 13.8, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 06:00': {'temp_c': 13.7, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 07:00': {'temp_c': 14.0, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 08:00': {'temp_c': 16.7, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 09:00': {'temp_c': 20.3, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 10:00': {'temp_c': 22.9, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 11:00': {'temp_c': 24.4, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 12:00': {'temp_c': 26.0, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 13:00': {'temp_c': 26.8, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 14:00': {'temp_c': 27.1, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 15:00': {'temp_c': 26.9, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 16:00': {'temp_c': 26.5, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 17:00': {'temp_c': 23.9, 'text': 'Sunny', 'icon': 'https://cdn.weatherapi.com/weather/64x64/day/113.png'}, '2024-01-26 18:00': {'temp_c': 20.3, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 19:00': {'temp_c': 19.2, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 20:00': {'temp_c': 18.8, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 21:00': {'temp_c': 18.3, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 22:00': {'temp_c': 17.9, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}, '2024-01-26 23:00': {'temp_c': 17.2, 'text': 'Clear', 'icon': 'https://cdn.weatherapi.com/weather/64x64/night/113.png'}}}}}
